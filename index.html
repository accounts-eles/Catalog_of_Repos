<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic GitHub Repository Catalog</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and simple colors  -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'github-dark': '#24292e',
                        'github-blue': '#0366d6',
                        'bg-light': '#f6f8fa',
                        'card-bg': '#ffffff',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar styling for a cleaner look */
        .repo-container::-webkit-scrollbar {
            width: 8px;
        }
        .repo-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        .repo-container::-webkit-scrollbar-track {
            background: #f3f4f6; /* gray-100 */
        }
        /* Checkbox styling */
        .repo-checkbox:checked {
            background-color: #0366d6;
            border-color: #0366d6;
        }
        .repo-card-selected {
            border-color: #0366d6 !important;
            ring: 2px;
            ring-color: #0366d6;
        }
    </style>
</head>
<body class="bg-bg-light min-h-screen font-sans p-4 sm:p-8 pb-32">

    <div class="max-w-4xl mx-auto">
        <!-- Header and Display Info -->
        <header class="text-center mb-8 p-6 bg-white shadow-lg rounded-xl border border-gray-100">
            <h1 class="text-3xl font-bold text-github-dark mb-2">Public Repositories Catalog</h1>
            <p class="text-gray-600">
                Displaying public repositories for the user:
                <span id="hardcodedUsernameDisplay" class="font-semibold text-github-blue"></span>
            </p>
        </header>

        <!-- User Profile Display Section -->
        <div id="userProfile" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8 hidden">
            <!-- Profile content will be injected here -->
        </div>
        
        <!-- Repository Search Filter & Select All -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
             <div class="relative flex-grow w-full">
                <input type="text" id="searchRepoInput" placeholder="Filter repositories by name or description..."
                       class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-github-blue shadow-sm transition duration-150 ease-in-out text-gray-700">
             </div>
             <button id="selectAllBtn" class="whitespace-nowrap px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition shadow-sm">
                Select All
             </button>
        </div>

        <!-- Loading Indicator & Error Message -->
        <div id="statusMessage" class="text-center text-lg text-gray-500 mb-4 hidden"></div>
        
        <!-- Repository Container -->
        <div id="repoContainer" class="repo-container grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Repository cards will be injected here -->
        </div>

        <!-- Footer -->
        <footer class="mt-10 text-center text-sm text-gray-500">
            Data fetched dynamically from the GitHub REST API and local previews.
        </footer>
    </div>

    <!-- Pinned Download Action Bar -->
    <div id="downloadBar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 transform translate-y-full transition-transform duration-300 ease-in-out z-50">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
                <span id="selectedCount" class="font-bold text-github-blue">0</span>
                <span class="text-gray-600 ml-1">repositories selected</span>
            </div>
            <div class="flex space-x-3">
                <button id="clearSelectionBtn" class="px-4 py-2 text-sm text-gray-500 hover:text-gray-800">Clear</button>
                <button id="downloadBundleBtn" class="flex items-center px-6 py-2 bg-github-blue text-white rounded-lg font-semibold hover:bg-blue-700 transition shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M7.5 12l4.5 4.5m0 0 4.5-4.5M12 3v13.5" />
                    </svg>
                    Download
                </button>
            </div>
        </div>
    </div>

    <script>
        // HARDCODED USERNAME
        const HARDCODED_USERNAME = 'accounts-eles';
        const EXCLUDED_REPO_NAME = 'Catalog_of_Repos';

        // Global state
        let currentRepos = []; 
        let selectedRepoIds = new Set();

        const repoContainer = document.getElementById('repoContainer');
        const statusMessage = document.getElementById('statusMessage');
        const usernameDisplay = document.getElementById('hardcodedUsernameDisplay');
        const searchRepoInput = document.getElementById('searchRepoInput');
        const downloadBar = document.getElementById('downloadBar');
        const selectedCountDisp = document.getElementById('selectedCount');
        const selectAllBtn = document.getElementById('selectAllBtn');

        window.onload = () => {
            usernameDisplay.textContent = HARDCODED_USERNAME;
            fetchAndDisplayRepos(HARDCODED_USERNAME);
            setupListeners();
        };

        function setupListeners() {
            searchRepoInput.addEventListener('input', handleSearch);
            
            selectAllBtn.addEventListener('click', () => {
                const visibleCheckboxes = document.querySelectorAll('.repo-checkbox');
                const allChecked = Array.from(visibleCheckboxes).every(cb => cb.checked);
                
                visibleCheckboxes.forEach(cb => {
                    cb.checked = !allChecked;
                    toggleRepoSelection(cb.dataset.id, !allChecked);
                });
                updateDownloadBar();
            });

            document.getElementById('clearSelectionBtn').addEventListener('click', () => {
                selectedRepoIds.clear();
                document.querySelectorAll('.repo-checkbox').forEach(cb => cb.checked = false);
                updateDownloadBar();
            });

            document.getElementById('downloadBundleBtn').addEventListener('click', handleBulkDownload);
        }

        function toggleRepoSelection(repoId, isSelected) {
            if (isSelected) {
                selectedRepoIds.add(repoId);
            } else {
                selectedRepoIds.delete(repoId);
            }
            updateDownloadBar();
        }

        function updateDownloadBar() {
            const count = selectedRepoIds.size;
            selectedCountDisp.textContent = count;
            if (count > 0) {
                downloadBar.classList.remove('translate-y-full');
            } else {
                downloadBar.classList.add('translate-y-full');
            }
        }

        async function handleBulkDownload() {
            const btn = document.getElementById('downloadBundleBtn');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin mr-2">‚è≥</span> Preparing files...`;

            const selectedRepos = currentRepos.filter(r => selectedRepoIds.has(r.id.toString()));
            
            for (const repo of selectedRepos) {
                const branch = repo.default_branch || 'main';
                // Note: We use sequential downloads to avoid browser spam-blocking popups
                await downloadRawFile(repo.owner.login, repo.name, branch, 'index.html');
                await downloadRawFile(repo.owner.login, repo.name, branch, 'README.md');
            }

            btn.disabled = false;
            btn.innerHTML = originalContent;
        }

        async function downloadRawFile(owner, repo, branch, filename) {
            const url = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filename}`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) return; // Skip if file doesn't exist

                const blob = await resp.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = `${repo}-${filename}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(blobUrl);
            } catch (e) {
                console.error(`Failed to download ${filename} for ${repo}`);
            }
        }

        function handleSearch() {
            const query = searchRepoInput.value.toLowerCase().trim();
            let reposToFilter = [...currentRepos]; 

            const filteredRepos = query ? reposToFilter.filter(repo => {
                const name = repo.name.toLowerCase();
                const description = (repo.description || '').toLowerCase();
                return name.includes(query) || description.includes(query);
            }) : reposToFilter;

            renderRepoCards(filteredRepos);
            
            if (filteredRepos.length === 0 && query) {
                displayStatus(`No repositories found matching "${query}".`, 'text-yellow-600');
            } else {
                displayStatus(`Displaying ${filteredRepos.length} matching repositories:`);
            }
        }
        
        function displayStatus(message, className = 'text-gray-500') {
            statusMessage.textContent = message;
            statusMessage.className = `text-center text-lg mb-4 ${className}`;
            statusMessage.classList.remove('hidden');
        }

        function displayProfile(user) {
            const profileElement = document.getElementById('userProfile');
            if (user.message === 'Not Found' || !user.login) {
                 profileElement.classList.add('hidden');
                 return;
            }

            const name = user.name || user.login;
            const bio = user.bio || 'No bio provided.';
            
            profileElement.innerHTML = `
                <div class="flex items-start">
                    <img src="${user.avatar_url}" alt="${name} Avatar" class="w-20 h-20 rounded-full mr-5 shadow-inner">
                    <div class="flex-grow">
                        <h2 class="text-2xl font-bold text-github-dark">${name}</h2>
                        <p class="text-lg text-gray-500 mb-2">@<a href="${user.html_url}" target="_blank" class="text-github-blue hover:underline">${user.login}</a></p>
                        <p class="text-gray-700 mb-3">${bio}</p>
                    </div>
                </div>
            `;
            profileElement.classList.remove('hidden');
        }

        function renderRepoCards(repos) {
            repoContainer.innerHTML = ''; 
            repos.forEach(repo => {
                repoContainer.appendChild(createRepoCard(repo));
            });
        }

        async function fetchAndDisplayRepos(username) {
            username = username.toLowerCase();
            displayStatus(`Loading profile and repositories for ${username}...`, 'text-blue-500');

            const userApiUrl = `https://api.github.com/users/${username}`;
            const reposApiUrl = `https://api.github.com/users/${username}/repos?type=public&sort=pushed&per_page=100`; 
            
            try {
                const [userResponse, reposResponse] = await Promise.all([
                    fetch(userApiUrl),
                    fetch(reposApiUrl)
                ]);

                if (userResponse.status === 404) {
                    displayStatus(`Error: GitHub user "${username}" not found.`, 'text-red-500');
                    return;
                }

                const userData = await userResponse.json();
                let repoData = await reposResponse.json();

                currentRepos = repoData.filter(repo => repo.name !== EXCLUDED_REPO_NAME);
                
                displayProfile(userData);

                if (currentRepos.length === 0) {
                    displayStatus(`User "${username}" has no public repositories.`, 'text-yellow-600');
                } else {
                    displayStatus(`Displaying ${currentRepos.length} public repositories:`);
                    renderRepoCards(currentRepos);
                }

            } catch (error) {
                displayStatus(`An error occurred while fetching data.`, 'text-red-500');
            }
        }

        function createRepoCard(repo) {
            const card = document.createElement('div');
            const isSelected = selectedRepoIds.has(repo.id.toString());
            
            card.className = `relative bg-card-bg rounded-xl shadow-md hover:shadow-lg transition duration-300 border ${isSelected ? 'border-github-blue ring-1 ring-github-blue' : 'border-gray-100'} flex flex-col justify-between overflow-hidden`;
            
            const targetUrl = `https://${repo.owner.login.toLowerCase()}.github.io/${repo.name}/`;
            const thumbnailUrl = `./previews/${repo.name}.png`;
            const placeholderUrl = `https://placehold.co/600x300/f6f8fa/24292e?text=${repo.name}`;

            card.innerHTML = `
                <div class="absolute top-3 right-3 z-10">
                    <input type="checkbox" data-id="${repo.id}" class="repo-checkbox w-6 h-6 rounded border-gray-300 text-github-blue focus:ring-github-blue cursor-pointer" ${isSelected ? 'checked' : ''}>
                </div>
                <a href="${targetUrl}" target="_blank" class="block aspect-video bg-gray-100">
                    <img src="${thumbnailUrl}" alt="${repo.name}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='${placeholderUrl}';">
                </a>
                <div class="p-5 flex flex-col justify-between flex-grow">
                    <div>
                        <h2 class="text-xl font-semibold text-github-blue hover:text-blue-700 mb-2 truncate">${repo.name}</h2>
                        <p class="text-sm text-gray-700 mb-4 min-h-[40px]">${repo.description || 'No description.'}</p>
                    </div>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span class="bg-gray-100 px-2 py-1 rounded">${repo.language || 'Plain Text'}</span>
                        <span>Updated ${timeSince(new Date(repo.pushed_at))} ago</span>
                    </div>
                </div>
            `;

            // Handle checkbox interaction
            const cb = card.querySelector('.repo-checkbox');
            cb.addEventListener('change', (e) => {
                toggleRepoSelection(repo.id.toString(), e.target.checked);
                if (e.target.checked) {
                    card.classList.add('border-github-blue', 'ring-1', 'ring-github-blue');
                } else {
                    card.classList.remove('border-github-blue', 'ring-1', 'ring-github-blue');
                }
            });

            return card;
        }

        function timeSince(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            return "recent";
        }
    </script>
</body>
</html>
